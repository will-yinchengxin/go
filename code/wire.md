# [wire](https://github.com/google/wire/blob/v0.5.0/docs/guide.md)

控制反转，面向对象中的一种设计原则，用来降低计算机代码之间的耦合度,最常见的方式叫做依赖注入（Dependency Injection，简称DI）

在开发中尽可能地使用控制反转和依赖注入将程序解耦开来，从而写出灵活和易测试的程序。

在应用程序中，手动去实现依赖的创建和注入就会比较麻烦的事情,那有没有什么办法能加速这个过程呢?

Go社区中有很多依赖注入框架。Uber的dig , Facebook的inject, 都使用反射来做运行时依赖注入。

Wire 是一个的 Google 开源的依赖注入工具，通过自动生成代码的方式在**编译期**完成依赖注入。

**安装方式很简单**

```shell
$ go install github.com/google/wire/cmd/wire@latest
```

```shell
$ wire -h
Usage: wire <flags> <subcommand> <subcommand args>

Subcommands:
	check            print any Wire errors found
	commands         list all command names
	diff             output a diff between existing wire_gen.go files and what gen would generate
	flags            describe all known top-level flags
	gen              generate the wire_gen.go file for each package
	help             describe subcommands and their syntax
	show             describe all top-level provider sets


Use "wire flags" for a list of top-level flags
```

## 1.两个基础概念

提供者（provider）和 注入器（injector）

### 1.1提供者（provider）

- 提供者函数必须是可导出的（首字母大写）以便被其他包导入。
- 提供者函数可以使用参数指定依赖项。
- 提供者函数也是可以返回错误的。
- 提供者函数可以分组为提供者函数集（**provider set**）。使用`wire.NewSet` 函数可以将多个提供者函数添加到一个集合中。如果经常同时使用多个提供者函数，这非常有用。

```go
package provider

import (
	"context"
	"errors"
	"github.com/google/wire"
)

var ProviderSet = wire.NewSet(NewX, NewY, NewZ)

type X struct {
	Value int
}

func NewX() X {
	return X{Value: 7}
}

type Y struct {
	Value int
}

func NewY(x X) Y {
	return Y{Value: x.Value + 1}
}

type Z struct {
	Value int
}

func NewZ(ctx context.Context, y Y) (Z, error) {
	if y.Value == 0 {
		return Z{}, errors.New("cannot provide z when value is zero")
	}
	return Z{Value: y.Value + 2}, nil
}
```

- 可以将其他提供者函数集添加到提供者函数集中。

```go
package provider

import (
    // ...
    "wire/example/pkg"
)

// ...

var MegaSet = wire.NewSet(ProviderSet, pkg.OtherSet)

```

### 1.2注入器（injector）

应用程序中是用一个注入器来连接提供者，注入器就是一个按照依赖顺序调用提供者。

使用 `wire`时，你只需要编写注入器的函数签名，然后 `wire`会生成对应的函数体。

要声明一个注入器函数只需要在函数体中调用`wire.Build`。这个函数的返回值也无关紧要，只要它们的类型正确即可。

```go
package Injector

import (
	"context"
	"github.com/google/wire"
	"wire/provider"
)

func BuildInjector(ctx context.Context) (provider.Z, error) {
	wire.Build(
		provider.ProviderSet,
	)

	return provider.Z{}, nil
}
```

与提供者一样，注入器也可以输入参数（然后将其发送给提供者），并且可以返回错误。

`wire.Build`的参数和`wire.NewSet`一样：都是提供者集合。这些就在该注入器的代码生成期间使用的提供者集。

上述代码保存在 `wire.go` 中。在 `wire.go` 所在目录下执行 `wire` 命令, 即可生成`wire_gen.go`

```shell
$ wire
wire: wire/Injector: wrote /code/Injector/wire_gen.go
```

```go
// Code generated by Wire. DO NOT EDIT.

//go:generate go run github.com/google/wire/cmd/wire
//go:build !wireinject
// +build !wireinject

package Injector

import (
	"context"
	"wire/provider"
)

// Injectors from Injector.go:
// 这里最多可以返回三个参数, 且返回的参数中, 最后一个参数一定是 error 类型
func BuildInjector(ctx context.Context) (provider.Z, error) {
	x := provider.NewX()
	y := provider.NewY(x)
	z, err := provider.NewZ(ctx, y)
	if err != nil {
		return provider.Z{}, err
	}
	return z, nil
}
```

## 2.高级特性

### 2.1 绑定接口

// 接口绑定是否只能一个接口绑定一个实现类

```go
package provider

type Animal interface {
	Eat() string
}

type Dog struct {
	Name string
}

func (d *Dog) Eat() string {
	return "dog food"
}

func ProvideDog() *Dog {
	return &Dog{}
}
```

```go
package Injector

import (
	"context"
	"github.com/google/wire"
	"wire/provider"
)

/*
* @package code/Injector/wire.go
* @author：Will Yin <826895143@qq.com>
* @copyright Copyright (C) 2023/8/28 Will

	这里的文件名一定要为 wire.go, 其中包含了文件中声明的接口的实现
    - 这里的返回参数的个数至多只能为 3 个
    - 第一个任意定义, 第二个必须为 func(), 第三个为 error(最后一个返回参数一定为 error 类型)
*/

func InitInjector(ctx context.Context) (provider.Z, func(), error) {
	wire.Build(
		provider.ProviderSet,
		provider.ProvideDog,
		// wire.Bind的第一个参数是指向所需接口类型值的指针，第二个参数是指向实现该接口的类型值的指针。
		// 任何包含接口绑定的集合还必须具有提供具体类型的提供者。
		wire.Bind(new(provider.Animal), new(*provider.Dog)),
	)

	return provider.Z{}, func() {}, nil
}
```

### 2.2 结构体提供者

除函数外，结构体也可以充当 Provider 的角色。

```go
type DogServer struct {
	Name string
  Food string
  Age  int
}

func NewDogServer(name, food string, age int) *DogServer {
   return &DogServer{
      Name: name,
      Food: food,
      Age:  age,
   }
}

// 等价于
wire.Struct(new(DogServer), "*") // "*"代表全部字段注入

// 也等价于
wire.Struct(new(DogServer), "Name", "Food", "Age")

// 如果个别属性不想被注入，那么可以修改 struct 定义:
type DogServer struct {
	Name string
  Food string
  Age  int `wire:"-"`
}
```

举例一个线上 demo

```go
package di

import (
	"github.com/google/wire"
	"will/app/controller"
	"will/app/modules/mysql/dao"
	"will/app/router"
	"will/app/service"
)``
var RouterSet = wire.NewSet(
	wire.Struct(new(router.Routers), "*"),
	wire.Struct(new(router.ApiRouter), "*"),
	wire.Struct(new(router.TyyunRouter), "*"),
	wire.Struct(new(router.AtameRouter), "*"),
)

var ControllerSet = wire.NewSet(
	wire.Struct(new(controller.Apps), "*"),
	wire.Struct(new(controller.Tyyun), "*"),
	wire.Struct(new(controller.Atame), "*"),
)

var ServiceSet = wire.NewSet(
	wire.Struct(new(service.Apps), "*"),
	wire.Struct(new(service.Tyyun), "*"),
	wire.Struct(new(service.Atame), "*"),
)

var Daoset = wire.NewSet(
	wire.Struct(new(dao.User), "*"),
	wire.Struct(new(dao.Tyyun), "*"),
	wire.Struct(new(dao.Atame), "*"),
)
```

```go
//go:build wireinject
// +build wireinject

package di

import (
	"github.com/google/wire"
)

func BuildInjector() (..., error) {
	wire.Build(
		ControllerSet,
		ServiceSet,
		RouterSet,
		Daoset,
	)
	// ....
}
```

### 2.3 绑定值

```go
// wire.go
package Injector

import (
	"context"
	"github.com/google/wire"
)

type Foo struct {
	X int
}

func InitInjector(ctx context.Context) (Foo, func(), error) {
	wire.Build(
		wire.Value(Foo{X: 42}),
	)
	return Foo{}, func() {}, nil
}
```

```go
// wire_gen.go
// Code generated by Wire. DO NOT EDIT.

//go:generate go run github.com/google/wire/cmd/wire
//go:build !wireinject
// +build !wireinject

package Injector

import (
	"context"
)

// Injectors from wire.go:

func InitInjector(ctx context.Context) (Foo, func(), error) {
	foo := _wireFooValue
	return foo, func() {
	}, nil
}

var (
	_wireFooValue = Foo{X: 42}
)

// wire.go:

type Foo struct {
	X int
}
```

值得注意的是，表达式将被复制到注入器的包中；对变量的引用将在注入器包的初始化过程中进行计算。如果表达式调用任何函数或从任何通道接收任何函数，`wire` 将会报错。

### 2.4 使用结构的字段作为提供者

有时，用户想要的提供程序是结构的某些字段。如果你发现自己在下面的示例中编写了一个类似`getS`的提供者，可以尝试将结构字段作为所提供的类型：

```go
type Foo struct {
    S string
    N int
    F float64
}

func getS(foo Foo) string {
    // Bad! Use wire.FieldsOf instead.
    return foo.S
}

func provideFoo() Foo {
    return Foo{ S: "Hello, World!", N: 1, F: 3.14 }
}

func injectedMessage() string {
    wire.Build(
        provideFoo,
        getS,
    )
    return ""
}
```

**可以使用`wire.FieldsOf`直接使用结构体的字段，而无需编写一个类似`getS`的函数：**

```go
//go:build wireinject
// +build wireinject

package Injector

import (
	"context"
	"github.com/google/wire"
)

type Foo struct {
	X int
	Y string
}

func providerFoo() Foo {
	return Foo{X: 1, Y: "hello"}
}

func InitInjector(ctx context.Context) int {
	wire.Build(
		providerFoo,
		wire.FieldsOf(&Foo{}, "X"),
	)
	return 0
}

```

生成的注射器如下所示：

```go
// Code generated by Wire. DO NOT EDIT.

//go:generate go run github.com/google/wire/cmd/wire
//go:build !wireinject
// +build !wireinject

package Injector

import (
	"context"
)

// Injectors from wire.go:

func InitInjector(ctx context.Context) int {
	foo := providerFoo()
	int2 := foo.X
	return int2
}

// wire.go:

type Foo struct {
	X int
	Y string
}

func providerFoo() Foo {
	return Foo{X: 1, Y: "hello"}
}
```

可以根据需要将任意多的字段名称添加到`wire.FieldsOf`中。

### 2.5 Cleanup函数

如果提供程序创建了一个需要清理的值（例如关闭文件、关闭数据库连接等），那么它可以返回一个闭包来清理资源。注入器将使用它向调用方返回聚合清理函数，或者在注入器实现中稍后调用的提供程序返回错误时清理资源。

Wire 对 Provider 的返回值个数及顺序有以下限制：

- 第一个返回值是需要生成的对象
- 如果有 2 个返回值，第二个返回值必须是 func() 或 error
- 如果有 3 个返回值，第二个返回值必须是 func()，而第三个返回值必须是 error

```go
// db.go
func InitGormDB()(*gorm.DB, func(), error) {
    // 初始化db链接
    // ...
    cleanFunc := func(){
        db.Close()
    }

    return db, cleanFunc, nil
}

// wire.go
func BuildInjector() (*Injector, func(), error) {
   wire.Build(
      common.InitGormDB,
      // ...
      NewInjector
   )

   return new(Injector), nil, nil
}

// 生成的wire_gen.go
func BuildInjector() (*Injector, func(), error) {
   db, cleanup, err := common.InitGormDB()
   // ...
   return injector, func(){
       // 所有provider的清理函数都会在这里
       cleanup()
   }, nil
}

// main.go
injector, cleanFunc, err := app.BuildInjector()
defer cleanFunc()
```

`cleanup`函数的签名必须是`func()`，并且保证在提供者的任何输入的cleanup函数之前调用。

## Demo

```go
// dao.go
// DalSet dal注入
var DalSet = wire.NewSet(
   ProjectSet,
   QuestionDalSet,
)

// wire.Struct方法是wire提供的构造器，"*"代表为所有字段注入值，在这里可以用"DB"代替
// wire.Bind方法把接口和实现绑定起来
var ProjectSet = wire.NewSet(
   wire.Struct(new(ProjectDal), "*"),
   wire.Bind(new(IProjectDal), new(*ProjectDal))
)

type IProjectDal interface {
   Create(ctx context.Context, item *entity.Project) (err error)
   // ...
}

type ProjectDal struct {
   DB *gorm.DB
}

func (dao *ProjectDal) Create(ctx context.Context, item *entity.Project) error {}


var QuestionDalSet = wire.NewSet(
   wire.Struct(new(QuestionDal), "*"),
   wire.Bind(new(IProjectDal), new(*QuestionDal))
)

type QuestionDal struct {
   DB *gorm.DB
}

func (dao *QuestionDal) Create(ctx context.Context, item *entity.Project) error {}
```

```go
// server.go
// ServiceSet service注入
var ServiceSet = wire.NewSet(
   ProjectSet,
   // other service set...
)

var ProjectSet = wire.NewSet(
   wire.Struct(new(ProjectService), "*"),
   wire.Bind(new(IProjectService), new(*ProjectService))
)

type IProjectService interface {
   Create(ctx context.Context, projectBo *bo.CreateProjectBo) (int64, error)
   // ...
}

type ProjectService struct {
   ProjectDal       dal.IProjectDal
   QuestionDal      dal.IQuestionDal
   QuestionModelDal dal.IQuestionModelDal

}
func (s *ProjectService) Create(ctx context.Context, projectBo *bo.ProjectCreateBo) (int64, error) {}
```

比较经典的使用案例为  grafana 源码中 `wire.go (/pkg/server/wire.go)` 

```go
//go:build wireinject
// +build wireinject

package server

import (
	"github.com/google/wire"
	sdkhttpclient "github.com/grafana/grafana-plugin-sdk-go/backend/httpclient"
	"github.com/grafana/grafana/pkg/api"
	// ......
)

var wireBasicSet = wire.NewSet(
	legacydataservice.ProvideService,
	wire.Bind(new(legacydata.RequestHandler), new(*legacydataservice.Service)),
	annotationsimpl.ProvideService,
	wire.Bind(new(annotations.Repository), new(*annotationsimpl.RepositoryImpl)),
	alerting.ProvideAlertStore,
	alerting.ProvideAlertEngine,
	wire.Bind(new(alerting.UsageStatsQuerier), new(*alerting.AlertEngine)),
	setting.NewCfgFromArgs,
	New,
	api.ProvideHTTPServer,
	query.ProvideService,
	bus.ProvideBus,
	wire.Bind(new(bus.Bus), new(*bus.InProcBus)),
	thumbs.ProvideService,
	rendering.ProvideService,
	wire.Bind(new(rendering.Service), new(*rendering.RenderingService)),
	routing.ProvideRegister,
	wire.Bind(new(routing.RouteRegister), new(*routing.RouteRegisterImpl)),
	hooks.ProvideService,
	kvstore.ProvideService,
	localcache.ProvideService,
	dashboardthumbsimpl.ProvideService,
	updatechecker.ProvideGrafanaService,
	updatechecker.ProvidePluginsService,
	uss.ProvideService,
	wire.Bind(new(usagestats.Service), new(*uss.UsageStats)),
	registry.ProvideService,
	wire.Bind(new(registry.Service), new(*registry.InMemory)),
	pluginsCfg.ProvideConfig,
	repo.ProvideService,
	wire.Bind(new(repo.Service), new(*repo.Manager)),
	manager.ProvideInstaller,
	wire.Bind(new(plugins.Installer), new(*manager.PluginInstaller)),
	client.ProvideService,
	wire.Bind(new(plugins.Client), new(*client.Service)),
	managerStore.ProvideService,
	wire.Bind(new(plugins.Store), new(*managerStore.Service)),
	wire.Bind(new(plugins.RendererManager), new(*managerStore.Service)),
	wire.Bind(new(plugins.SecretsPluginManager), new(*managerStore.Service)),
	wire.Bind(new(plugins.StaticRouteResolver), new(*managerStore.Service)),
	pluginDashboards.ProvideFileStoreManager,
	wire.Bind(new(pluginDashboards.FileStore), new(*pluginDashboards.FileStoreManager)),
	processManager.ProvideService,
	wire.Bind(new(processManager.Service), new(*processManager.Manager)),
	coreplugin.ProvideCoreRegistry,
	loader.ProvideService,
	wire.Bind(new(loader.Service), new(*loader.Loader)),
	wire.Bind(new(plugins.ErrorResolver), new(*loader.Loader)),
	cloudwatch.ProvideService,
	cloudmonitoring.ProvideService,
	azuremonitor.ProvideService,
	postgres.ProvideService,
	mysql.ProvideService,
	mssql.ProvideService,
	store.ProvideEntityEventsService,
	httpclientprovider.New,
	wire.Bind(new(httpclient.Provider), new(*sdkhttpclient.Provider)),
	serverlock.ProvideService,
	annotationsimpl.ProvideCleanupService,
	wire.Bind(new(annotations.Cleaner), new(*annotationsimpl.CleanupServiceImpl)),
	cleanup.ProvideService,
	shorturls.ProvideService,
	wire.Bind(new(shorturls.Service), new(*shorturls.ShortURLService)),
	queryhistory.ProvideService,
	wire.Bind(new(queryhistory.Service), new(*queryhistory.QueryHistoryService)),
	correlations.ProvideService,
	wire.Bind(new(correlations.Service), new(*correlations.CorrelationsService)),
	quotaimpl.ProvideService,
	remotecache.ProvideService,
	loginservice.ProvideService,
	wire.Bind(new(login.Service), new(*loginservice.Implementation)),
	authinfoservice.ProvideAuthInfoService,
	wire.Bind(new(login.AuthInfoService), new(*authinfoservice.Implementation)),
	authinfodatabase.ProvideAuthInfoStore,
	loginpkg.ProvideService,
	wire.Bind(new(loginpkg.Authenticator), new(*loginpkg.AuthenticatorService)),
	datasourceproxy.ProvideService,
	search.ProvideService,
	searchV2.ProvideService,
	searchV2.ProvideSearchHTTPService,
	store.ProvideService,
	export.ProvideService,
	live.ProvideService,
	pushhttp.ProvideService,
	plugincontext.ProvideService,
	contexthandler.ProvideService,
	jwt.ProvideService,
	wire.Bind(new(models.JWTService), new(*jwt.AuthService)),
	ngstore.ProvideDBStore,
	ngimage.ProvideDeleteExpiredService,
	ngalert.ProvideService,
	librarypanels.ProvideService,
	wire.Bind(new(librarypanels.Service), new(*librarypanels.LibraryPanelService)),
	libraryelements.ProvideService,
	wire.Bind(new(libraryelements.Service), new(*libraryelements.LibraryElementService)),
	notifications.ProvideService,
	notifications.ProvideSmtpService,
	tracing.ProvideService,
	metrics.ProvideService,
	testdatasource.ProvideService,
	opentsdb.ProvideService,
	social.ProvideService,
	influxdb.ProvideService,
	wire.Bind(new(social.Service), new(*social.SocialService)),
	oauthtoken.ProvideService,
	auth.ProvideActiveAuthTokenService,
	wire.Bind(new(auth.ActiveTokenService), new(*auth.ActiveAuthTokenService)),
	wire.Bind(new(oauthtoken.OAuthTokenService), new(*oauthtoken.Service)),
	tempo.ProvideService,
	loki.ProvideService,
	graphite.ProvideService,
	prometheus.ProvideService,
	elasticsearch.ProvideService,
	phlare.ProvideService,
	parca.ProvideService,
	encryptionservice.ProvideEncryptionService,
	wire.Bind(new(encryption.Internal), new(*encryptionservice.Service)),
	secretsManager.ProvideSecretsService,
	wire.Bind(new(secrets.Service), new(*secretsManager.SecretsService)),
	secretsDatabase.ProvideSecretsStore,
	querylibraryimpl.ProvideService,
	querylibraryimpl.ProvideHTTPService,
	wire.Bind(new(secrets.Store), new(*secretsDatabase.SecretsStoreImpl)),
	secretsMigrator.ProvideSecretsMigrator,
	wire.Bind(new(secrets.Migrator), new(*secretsMigrator.SecretsMigrator)),
	grafanads.ProvideService,
	wire.Bind(new(dashboardsnapshots.Store), new(*dashsnapstore.DashboardSnapshotStore)),
	dashsnapstore.ProvideStore,
	wire.Bind(new(dashboardsnapshots.Service), new(*dashsnapsvc.ServiceImpl)),
	dashsnapsvc.ProvideService,
	datasourceservice.ProvideService,
	wire.Bind(new(datasources.DataSourceService), new(*datasourceservice.Service)),
	pluginSettings.ProvideService,
	wire.Bind(new(pluginsettings.Service), new(*pluginSettings.Service)),
	alerting.ProvideService,
	database.ProvideServiceAccountsStore,
	wire.Bind(new(serviceaccounts.Store), new(*database.ServiceAccountsStoreImpl)),
	ossaccesscontrol.ProvideServiceAccountPermissions,
	wire.Bind(new(accesscontrol.ServiceAccountPermissionsService), new(*ossaccesscontrol.ServiceAccountPermissionsService)),
	wire.Bind(new(dashboards.PluginService), new(*dashboardservice.DashboardServiceImpl)),
	wire.Bind(new(dashboards.Store), new(*dashboardstore.DashboardStore)),
	dashboardimportservice.ProvideService,
	wire.Bind(new(dashboardimport.Service), new(*dashboardimportservice.ImportDashboardService)),
	plugindashboardsservice.ProvideService,
	wire.Bind(new(plugindashboards.Service), new(*plugindashboardsservice.Service)),
	plugindashboardsservice.ProvideDashboardUpdater,
	alerting.ProvideDashAlertExtractorService,
	wire.Bind(new(alerting.DashAlertExtractor), new(*alerting.DashAlertExtractorService)),
	comments.ProvideService,
	guardian.ProvideService,
	sanitizer.ProvideService,
	secretsStore.ProvideService,
	avatar.ProvideAvatarCacheServer,
	authproxy.ProvideAuthProxy,
	statscollector.ProvideService,
	corekind.KindSet,
	cuectx.GrafanaCUEContext,
	cuectx.GrafanaThemaRuntime,
	csrf.ProvideCSRFFilter,
	ossaccesscontrol.ProvideTeamPermissions,
	wire.Bind(new(accesscontrol.TeamPermissionsService), new(*ossaccesscontrol.TeamPermissionsService)),
	ossaccesscontrol.ProvideFolderPermissions,
	wire.Bind(new(accesscontrol.FolderPermissionsService), new(*ossaccesscontrol.FolderPermissionsService)),
	ossaccesscontrol.ProvideDashboardPermissions,
	wire.Bind(new(accesscontrol.DashboardPermissionsService), new(*ossaccesscontrol.DashboardPermissionsService)),
	starimpl.ProvideService,
	playlistimpl.ProvideService,
	apikeyimpl.ProvideService,
	dashverimpl.ProvideService,
	publicdashboardsService.ProvideService,
	wire.Bind(new(publicdashboards.Service), new(*publicdashboardsService.PublicDashboardServiceImpl)),
	publicdashboardsStore.ProvideStore,
	wire.Bind(new(publicdashboards.Store), new(*publicdashboardsStore.PublicDashboardStoreImpl)),
	publicdashboardsApi.ProvideApi,
	userimpl.ProvideService,
	orgimpl.ProvideService,
	grpccontext.ProvideContextHandler,
	grpcserver.ProvideService,
	grpcserver.ProvideHealthService,
	grpcserver.ProvideReflectionService,
	interceptors.ProvideAuthenticator,
	kind.ProvideService, // The registry of known kinds
	sqlstash.ProvideSQLObjectServer,
	resolver.ProvideObjectReferenceResolver,
	httpobjectstore.ProvideHTTPObjectStore,
	teamimpl.ProvideService,
	tempuserimpl.ProvideService,
	loginattemptimpl.ProvideService,
	userauthimpl.ProvideService,
	secretsMigrations.ProvideDataSourceMigrationService,
	secretsMigrations.ProvideMigrateToPluginService,
	secretsMigrations.ProvideMigrateFromPluginService,
	secretsMigrations.ProvideSecretMigrationProvider,
	wire.Bind(new(secretsMigrations.SecretMigrationProvider), new(*secretsMigrations.SecretMigrationProviderImpl)),
	acimpl.ProvideAccessControl,
	navtreeimpl.ProvideService,
	wire.Bind(new(accesscontrol.AccessControl), new(*acimpl.AccessControl)),
	wire.Bind(new(notifications.TempUserStore), new(tempuser.Service)),
	tagimpl.ProvideService,
	wire.Bind(new(tag.Service), new(*tagimpl.Service)),
)

var wireSet = wire.NewSet(
	wireBasicSet,
	sqlstore.ProvideService,
	ngmetrics.ProvideService,
	wire.Bind(new(notifications.Service), new(*notifications.NotificationService)),
	wire.Bind(new(notifications.WebhookSender), new(*notifications.NotificationService)),
	wire.Bind(new(notifications.EmailSender), new(*notifications.NotificationService)),
	wire.Bind(new(sqlstore.Store), new(*sqlstore.SQLStore)),
	wire.Bind(new(db.DB), new(*sqlstore.SQLStore)),
	prefimpl.ProvideService,
)

var wireTestSet = wire.NewSet(
	wireBasicSet,
	ProvideTestEnv,
	sqlstore.ProvideServiceForTests,
	ngmetrics.ProvideServiceForTest,

	notifications.MockNotificationService,
	wire.Bind(new(notifications.Service), new(*notifications.NotificationServiceMock)),
	wire.Bind(new(notifications.WebhookSender), new(*notifications.NotificationServiceMock)),
	wire.Bind(new(notifications.EmailSender), new(*notifications.NotificationServiceMock)),
	mockstore.NewSQLStoreMock,
	wire.Bind(new(sqlstore.Store), new(*sqlstore.SQLStore)),
	wire.Bind(new(db.DB), new(*sqlstore.SQLStore)),
	prefimpl.ProvideService,
)

func Initialize(cla setting.CommandLineArgs, opts Options, apiOpts api.ServerOptions) (*Server, error) {
	wire.Build(wireExtsSet)
	return &Server{}, nil
}

func InitializeForTest(cla setting.CommandLineArgs, opts Options, apiOpts api.ServerOptions) (*TestEnv, error) {
	wire.Build(wireExtsTestSet)
	return &TestEnv{Server: &Server{}, SQLStore: &sqlstore.SQLStore{}}, nil
}

```





















